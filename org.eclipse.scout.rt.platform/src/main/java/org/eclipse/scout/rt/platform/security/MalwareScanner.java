/*******************************************************************************
 * Copyright (c) 2010-2015 BSI Business Systems Integration AG.
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Public License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/legal/epl-v10.html
 *
 * Contributors:
 *     BSI Business Systems Integration AG - initial API and implementation
 ******************************************************************************/
package org.eclipse.scout.rt.platform.security;

import java.io.File;
import java.io.FileInputStream;
import java.util.Arrays;

import org.eclipse.scout.rt.platform.Bean;
import org.eclipse.scout.rt.platform.exception.PlatformException;
import org.eclipse.scout.rt.platform.resource.BinaryResource;
import org.eclipse.scout.rt.platform.util.IOUtility;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * <h3>{@link MalwareScanner}</h3> Facility used to scan files and resources for malware
 * <p>
 * This default scanner assumes that an appropriate malware scanner is in place and scans the TEMP folder (as used by
 * {@link File#createTempFile(String, String)} ) using a realtime filesystem scan strategy. Malware should therefore
 * immediately be removed or blocked by the malware implementation.
 * <p>
 * Override this {@link Bean} in order to implement another scanning strategy.
 *
 * @since 5.2
 */
@Bean
public class MalwareScanner {
  private static final Logger LOG = LoggerFactory.getLogger(MalwareScanner.class);

  /**
   * This {@link MalwareScanner} copies the resource to be scanned intto the TEMP folder, reads it back in and verifies
   * the equality of the two streams.
   * <p>
   * Override this {@link Bean} in order to implement another scanning strategy.
   *
   * @throws PlatformException
   *           if the resource is valid and the scanner did not find any issues
   */
  public void scan(BinaryResource res) {
    if (res == null) {
      return;
    }
    File f = null;
    try {
      byte[] expected = res.getContent();
      if (expected == null || expected.length == 0) {
        return;
      }
      f = IOUtility.createTempFile("malware-scan", ".tmp", expected);
      byte[] actual;
      try (FileInputStream in = new FileInputStream(f)) {
        actual = IOUtility.getContent(in, expected.length);
      }
      if (!Arrays.equals(expected, actual)) {
        throwUnsafeResource(res);
      }
    }
    catch (Exception e) {//NOSONAR each on-site malware scanner may behave differently, e.g. StreamCorruptedException, FileNotFoundException, ...
      throwUnsafeResource(res);
    }
    finally {
      IOUtility.deleteFile(f);
    }
  }

  protected void throwUnsafeResource(BinaryResource res) {
    LOG.info("detected unsafe resource '{}'", res.getFilename());
    throw new PlatformException("Resource '{}' is not safe", res.getFilename());
  }

}
